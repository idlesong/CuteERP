<div class="page-header">
  <h1>Welcome <%= current_user.name %>!</h1>
</div>

<h3> Customer Orders(Unissued PO in lineitems) </h3>
<table class="table">
  <thead>
    <tr>
      <th><h4>#-Customer PO#</h4></th>
      <th><h4>Customer</h4></th>
      <th><h4>Date</h4></th>
      <th><h4>Product name</h4></th>
      <th><h4>PartNo.</h4></th>
      <th><h4>Price</h4></th>
      <th><h4>Qty</h4></th>
      <th><h4>Qty left</h4></th>
      <th><h4>Suble Total</h4></th>
      <th><h4>Action</th></th>
    </tr>
  </thead>

  <% @orders.each do |order| %>

  <% if order.customer.currency == 'RMB'
        currency_unit = '¥'
      else
        currency_unit = '$'
      end %>

  <% if not order.line_items.nil? then %>
    <% order.line_items.each do |line_item|%>
      <% if line_item.quantity > line_item.quantity_issued %>
        <tr>
          <td>#<%= link_to(order.id,order_path(order.id)) %>-<%= order.order_number %></td>
          <td><%= order.customer.short_name %></td>
          <td><%= order.created_at.strftime("%F") %>
          <td><%= line_item.item.name %> </td>
          <td><%= line_item.full_part_number %> </td>
              <% line_price = line_item.show_currency_price(order.exchange_rate, order.customer.currency) %>
          <td><%= number_to_currency(line_price, unit: currency_unit) %> </td>
          <td>x<%= line_item.quantity %> </td>
          <td> <%= line_item.quantity - line_item.quantity_issued %> </td>
          <td><%= number_to_currency(line_item.total_currency_price(order.exchange_rate, order.customer.currency), unit: currency_unit) %></td>
          <td>
          <% if line_item.quantity > line_item.quantity_issued then %>
            <%= link_to "issue", new_sales_order_path(:customer_id => order.customer.id) %>
          <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  <% end %>
  <% end %>
</table>

<%= link_to 'New Order', new_order_path, :class=>"btn btn-primary" %>

<!-- Listing sales orders -->
<h3> Sales Orders(list in lineitems) </h3>
<table class="table">
  <thead>
    <tr>
      <th><h4>SO#</h4></th>
      <th><h4>Customer</h4></th>
      <th><h4>Refer PO#</h4></th>
      <th><h4>Product name</h4></th>
      <th><h4>PartNo.</h4></th>
      <th><h4>Price</h4></th>
      <th><h4>Qty</h4></th>
      <th><h4>Suble Total</h4></th>
      <th><h4>Ship Date</h4></th>
    </tr>
  </thead>

  <% @sales_orders.each do |order| %>
    <% if order.customer.currency == 'RMB'
          currency_unit = '¥'
        else
          currency_unit = '$'
        end %>

    <% if not order.line_items.nil? then %>
      <% order.line_items.each do |line_item|%>
      <% order_number = find_order_number_from_reference(line_item.refer_line_id) %>
        <tr>
          <td>#<%= link_to(order.id,sales_order_path(order.id)) %>-<%= order.serial_number%></td>
          <td><%= order.customer.short_name %></td>
          <td><%= order_number%></td>
          <td><%= line_item.item.name %> </td>
          <td><%= line_item.full_part_number %> </td>
          <% line_price = line_item.show_currency_price(order.exchange_rate, order.customer.currency) %>
          <td><%= number_to_currency(line_price, unit: currency_unit) %> </td>
          <td>x<%= line_item.quantity %> </td>
          <td><%= number_to_currency(line_item.total_currency_price(order.exchange_rate, order.customer.currency), unit: currency_unit) %></td>
          <td>
            <% if order.delivery_date %>
              <a data-toggle="tooltip" data-placement="top" title="SF201572441752">
                <%= order.delivery_date.to_date%></a>
            <% else %>
              <%= link_to('ship now', confirm_sales_order_path(order.id)) %>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  <% end %>
</table>

</br>
